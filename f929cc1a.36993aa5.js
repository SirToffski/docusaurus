(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{158:function(t,e,n){"use strict";n.r(e),n.d(e,"frontMatter",(function(){return s})),n.d(e,"metadata",(function(){return i})),n.d(e,"rightToc",(function(){return l})),n.d(e,"default",(function(){return p}));var r=n(1),o=n(9),a=(n(0),n(165)),s={id:"block-that",title:"Create IP black-list"},i={id:"block-that",title:"Create IP black-list",description:"## Usage",source:"@site/docs/block-that.md",permalink:"/docs/block-that",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/block-that.md",sidebar:"scripts",previous:{title:"Get my public IP",permalink:"/docs/my-pub-ip"},next:{title:"Fish Prompt",permalink:"/docs/fish-prompt"}},l=[{value:"Usage",id:"usage",children:[]},{value:"Code",id:"code",children:[]}],c={rightToc:l};function p(t){var e=t.components,n=Object(o.a)(t,["components"]);return Object(a.b)("wrapper",Object(r.a)({},c,n,{components:e,mdxType:"MDXLayout"}),Object(a.b)("h2",{id:"usage"},"Usage"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"You've got a router running OpenWRT or any other Unix-based OS"),Object(a.b)("li",{parentName:"ul"},"The router is configured to log IPTABLES, login, etc. events in the syslog"),Object(a.b)("li",{parentName:"ul"},"The router is also sending all the logs in real-time to a server (via syslog-ng for example)"),Object(a.b)("li",{parentName:"ul"},"You'd like to extract useful information from this log daily")),Object(a.b)("p",null,'As described above, this script runs on my server daily.\nIt looks for "DROP" messages from IPTABLES and builds a master file with offending IPs'),Object(a.b)("p",null,'There are two "master files". One labelled "top_assholes.txt" contains duplicates because it\'s structured as:'),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),"2019.06.05_05:35:01 - Today's top assholes are:\n.....\n2019.06.05_12:40:02 - Today's top assholes are:\n.....\n")),Object(a.b)("p",null,'Second "master file" master_blocklist.txt contains only unique IPv4 addresses collected by the script\nSimilarly, this script can be made to track logins, DHCP, etc. - any info of interest in the syslog.'),Object(a.b)("h2",{id:"code"},"Code"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),'#!/usr/bin/env bash\n## VARIABLES ##\n# This valriable may not be required, depending on your setup. In this case syslog-ng makes a new folder daily named as the variable describes.\ntoday_dir=$(date +%Y.%m.%d)\n\ntoday_expanded=$(date +%Y.%m.%d_%T)\nrouter_IP=Bifrost\nlog_location=/var/log/network/"$router_IP"/"$today_dir"/messages\nscript_location=$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)\nquery_of_interest="DROP"\n###############\n\n# Get list of rejected IPs from router logs\ngrep "$query_of_interest" "$log_location" >"$script_location"/$"today_dir"_assholes.txt\n\n# Extract Source IP addresses only\ngrep -Eo "SRC=[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}" "$script_location"/$"today_dir"_assholes.txt >"$script_location"/$"today_dir"_assholes_ip.txt\n\n# Add time and date to the top file\nprintf %b\\\\n "\n-------------------------------------------\n$today_expanded - Today\'s top assholes are:\n-------------------------------------------\n" >>"$script_location"/top_assholes.txt\n\n# Remove dupes from today\'s list and append them to the top file\nsort -n "$script_location"/$"today_dir"_assholes_ip.txt | uniq >>"$script_location"/top_assholes.txt\n\n# Again filter top file by IPs only\ngrep -Eo \'[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\' "$script_location"/top_assholes.txt | sort -n | uniq >"$script_location"/master_blocklist.txt\n\n# Now we need to clean up\n\n# Remove 0.0.0.0 from the list\nsed -i \'s/0\\.0\\.0\\.0//g\' "$script_location"/master_blocklist.txt\n\n# Remove private LAN 192.168.1.0/24 and 192.168.2.0/24 from the list\nsed -i -E \'s/192\\.168\\.[1-2]\\.[0-9]{1,3}//g\' "$script_location"/master_blocklist.txt\n\n# Finally remove 255.255.255.255\nsed -i \'s/255\\.255\\.255\\.255//g\' "$script_location"/master_blocklist.txt\n\n# And last but not the least, remove empty lines from the master list\nsed -i \'/^$/d\' "$script_location"/master_blocklist.txt\n# Final sort and de-dup\ncp "$script_location"/master_blocklist.txt "$script_location"/master_blocklist1.txt\ngrep -Eo \'[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\' "$script_location"/master_blocklist1.txt | sort -n | uniq >"$script_location"/master_blocklist.txt\n\n# Housekeeping - removing un-needed files\nrm "$script_location"/{"$today_dir"_assholes.txt,"$today_dir"_assholes_ip.txt,master_blocklist1.txt}\n\n\n\n# OPTIONAL: Setup cron to execute the script at certain time\n# Three tasks to run the script daily at 23:30, 05:30, 12:40\n#printf %b\\\\n "30 23   *   *   *    sudo bash $script_location/block_that.sh" | sudo tee -a "$crontab_file" > /dev/null\n#printf %b\\\\n "30 05   *   *   *    sudo bash $script_location/block_that.sh" | sudo tee -a "$crontab_file" > /dev/null\n#printf %b\\\\n "40 12   *   *   *    sudo bash $script_location/block_that.sh" | sudo tee -a "$crontab_file" > /dev/null\n')))}p.isMDXComponent=!0},165:function(t,e,n){"use strict";n.d(e,"a",(function(){return d})),n.d(e,"b",(function(){return m}));var r=n(0),o=n.n(r);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function l(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},a=Object.keys(t);for(r=0;r<a.length;r++)n=a[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);for(r=0;r<a.length;r++)n=a[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}var c=o.a.createContext({}),p=function(t){var e=o.a.useContext(c),n=e;return t&&(n="function"==typeof t?t(e):i({},e,{},t)),n},d=function(t){var e=p(t.components);return o.a.createElement(c.Provider,{value:e},t.children)},u={inlineCode:"code",wrapper:function(t){var e=t.children;return o.a.createElement(o.a.Fragment,{},e)}},b=Object(r.forwardRef)((function(t,e){var n=t.components,r=t.mdxType,a=t.originalType,s=t.parentName,c=l(t,["components","mdxType","originalType","parentName"]),d=p(n),b=r,m=d["".concat(s,".").concat(b)]||d[b]||u[b]||a;return n?o.a.createElement(m,i({ref:e},c,{components:n})):o.a.createElement(m,i({ref:e},c))}));function m(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var a=n.length,s=new Array(a);s[0]=b;var i={};for(var l in e)hasOwnProperty.call(e,l)&&(i[l]=e[l]);i.originalType=t,i.mdxType="string"==typeof t?t:r,s[1]=i;for(var c=2;c<a;c++)s[c]=n[c];return o.a.createElement.apply(null,s)}return o.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"}}]);