<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">


<title data-react-helmet="true">A Brief description of my home network</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="A Brief description of my home network"><meta data-react-helmet="true" name="description" content="In this post I will briefly describe my current home network setup."><meta data-react-helmet="true" property="og:description" content="In this post I will briefly describe my current home network setup."><meta data-react-helmet="true" name="twitter:card" content="summary">

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico">


<link rel="stylesheet" href="/styles.f1f9fc96.css">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong>SirToffski</strong></a><a class="navbar__item navbar__link" href="/docs/my-recipes">My Recipe Collection</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/scripts">Scripts</a><a class="navbar__item navbar__link" href="/docs/about-me">About Me</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/SirToffski/">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong>SirToffski</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/my-recipes">My Recipe Collection</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/scripts">Scripts</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/about-me">About Me</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/SirToffski/">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--xl"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_2RZH">A Brief description of my home network</h1><div class="margin-bottom--sm"><time datetime="2019-07-22T00:00:00.000Z" class="blogPostDate_3tRe">July 22, 2019</time></div><div class="avatar margin-bottom--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/SirToffski" target="_blank" rel="noreferrer noopener">SirToffski</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>In this post I will briefly describe my current home network setup.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="basic-setup"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#basic-setup" title="Direct link to heading">#</a>Basic setup</h3><p>Lately, I&#x27;ve been pretty busing during my days off with setting up my home network. I&#x27;d like to thank my girlfriend for putting up with frequent &quot;I need to restart the router&quot; and other interruptions that came up during the process.</p><p>The setup is far from sophisticated for many reasons. Mostly, good network and server equipment is not cheap ;). Furthermore, I have yet to complete some elements of the setup. I will provide more details below.</p><p>Here is the basic layout:</p><p><img src="/img/SOHO.png" alt="SOHO"></p><p>Some brief points to mention:</p><ul><li>The ISP provided gateway has a feature called &quot;Advanced DMZ&quot;. Basically, it&#x27;s a poor-man&#x27;s-bridge allowing the downstream EdgeRouter X to grab a public /20 DHCP address directly from the ISP.</li><li>On EdgeRouter - WAN iface is vlan 2 to which I&#x27;ve added a static interface <code>192.168.2.250/24</code> - outside of DHCP range provded by the upstream IPS-provided gateway.
<img src="/img/upstreamIPV4.jpg.png" alt="upstream-ipv4"></li><li>vlan 1 on the EdgeRouter is LAN <code>192.168.1.0/24</code> giving out DHCP addresses to the downstream devices within that range. This is where the home server hosting Pi-Hole exists - which takes care of DNS for all devices both within <code>192.168.2.0/24</code> and <code>192.168.1.0/24</code>. To make sure devices in 192.168.2.0/24 can reach the 192.168.1.0/24 network, I&#x27;ve added a static route on the ISP-privided gateway shown in a pic:<br><img src="/img/static-route.png" alt="static-route">.</li><li>EdgeRouter X also acts as an L3VPN server/gteway via WireGuard. More on the subject below.</li></ul><p>Eventually the plan is to get an APU board to act as firewall + hosting PiHole; a simple managed L2 switch and wireless APs to move everything over to the EdgeRouter X, completely bypassing the ISP&#x27;s gateway.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="home-server"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#home-server" title="Direct link to heading">#</a>Home server</h3><p>For the time being I&#x27;ve repurposed an old laptop to be a home server. It&#x27;s running Manjaro Linux. I&#x27;ve thought of installing Ubuntu Server first, but having AUR is such a nice bonus. Furthermore, Pacman is by far my favourite package manager - hence I opted for Manjaro. Arch would have been a better choise perhaps, however at the time of setting things up speedy setup was a higher priority.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="pi-hole"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pi-hole" title="Direct link to heading">#</a>Pi-Hole</h4><p>The home server is hosting <a href="https://pi-hole.net/">Pi-Hole</a> for network wide ad-blocking. If you are not familiar with Pi-Hole, I encourage you to check it out - a great project. My favourite features are insight into DNS queries on the network (who knew how much junk Samsung TVs send), and awesome graphs showing a nice overview of DNS traffic.</p><p><img src="/img/pi-hole-dashboard.png" alt="pi-hole-dashboard"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="syslog-ng"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#syslog-ng" title="Direct link to heading">#</a>Syslog-ng</h4><p>On a fine spring evening I&#x27;ve decided to check the syslog on EdgeRouter. Perhaps unsurprisingly, there were tons of IPTABLES REJECT messages of random IPs scanning my ports. It would be a shame is this information was lost after rebooting the ERX, so I&#x27;ve installed syslog-ng on my home server. The ERX is configured to send all syslogs over to the server, which are stored in <code>/var/log/network/router-ip/year-month-day/messages</code> file. It was a matter of writing a quick bash script to filter the logs by <code>REJECT</code> querie, extract IPv4 addresses only, remove duplicates, filter out private LAN <code>192.168.2.0/24</code> IPs and build a master blocklist - drawing some inspiration from Fail2ban. The master blocklist is then sent to a GitHub gist a few times every day.</p><p>The ERX router has a cron job going to download the latest copy of the blocklist daily and add the IPs to the blacklist.</p><p>You can check out the original script <a href="https://gist.github.com/SirToffski/6992b8483505f9075a958b7bfb3e640d">here</a> and the master blocklist <a href="https://gist.github.com/SirToffski/f80b894a197b1aa57729f175fda67dbe">here</a>. Already at 22297 unique addresses. Wow!</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="tig-stack"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#tig-stack" title="Direct link to heading">#</a>TIG Stack</h4><p>Finally, the home server is running a TIG Stack (Telegraf, InfluxDB, Grafana) to collect basic information about the home server. Currently, it&#x27;s monitoring DNS queries using Pi-Hole APIs and some general linux host stats of the home server - CPU, memory, load average, etc. You can check the dashboards out <a href="https://raw.githubusercontent.com/SirToffski/sirtoffski.github.io/master/images/grafana-1.png">here</a> and <a href="https://raw.githubusercontent.com/SirToffski/sirtoffski.github.io/master/images/grafana-2.png">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="secutiry"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#secutiry" title="Direct link to heading">#</a>Secutiry</h3><p>Finally, I wanted to mention the ERX is running <a href="https://tools.ietf.org/html/bcp38">BCP38</a> to block bogus forged ingress prefixes. Perhaps an overkill, it was easy to implement and makes me sleep better :). Of course the defaul firewall policy on ERX is to deny an ingress traffic unless explicitly allowed. SSH logins with password have been disabled on both ERX router and home server and the ports on which OpenSSH server listens on have been changed.</p><p>Speaking of OpenSSH - by default OpenWRT comes with <code>dropbear</code> as an SSH server - which I&#x27;ve disabled an installed OpenSSH instead. I&#x27;ve opted not to use RSA key, instead going for ED25519.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="wireguard"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#wireguard" title="Direct link to heading">#</a>WireGuard</h3><p>For those unfamiliar with WireGuard, <em>WireGuard</em> is a <strong>layer 3 network tunnel</strong>. It uses <em>Curve25519</em> points as pre-shared static keys to achieve mutual authentication, drawing it&#x27;s inspiration from <em>OpenSSH</em>. For more information check out <a href="#references">1</a>,<a href="#references">2</a>,<a href="#references">3</a>,<a href="#references">4</a>.</p><p>Spinning up a WireGuard server instance is a piece of cake. One of my ongoing projects is specifically designed to automate a large portion of the process. Check it out - <a href="https://github.com/SirToffski/WireGuard-Ligase">WireGuard-Ligase</a>.</p><p>At the time of writing, I&#x27;ve got three WireGuard servers running. Two of them run as Ubuntu 18.04/CentOS 7 servers on Amazon EC2 - one in Montreal, the other on Ohio. The third one is setup on my home EdgeRouter X. While the EC2 instances are for mostly for testing purposes, the server hosted on my home router is for daily use.</p><p>Why would I host a WireGuard server from home?</p><ul><li>Fist, we all know about how sketchy public WiFi is. Having a secure tunnel to my home network make it much harder to snoop my traffic.</li><li>Second, remember Pi-Hole? Guess what, with a WireGuard tunnel to my home router, my devices can take advantage of Pi-Hole ad-blocking from anywhere. So no matter where I am, even using my cellphone data, my adds are blocked.</li><li>Finally, it&#x27;s a nice bonus to be able to access my home devices remotely without worrying about security too much.</li></ul><p>One of the challenges of setting up a server at home is due to not having a static address. My ISP DHCPs a public IPv4 address over to my ERX, which may change at any time. For now, I&#x27;ve written a quick script on my server to check the public IP address a few times a day and to save it to a private github gist. If the address changes, all I&#x27;d have to do is check out the gist and update a client config on my devices. Not too difficult.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="references"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#references" title="Direct link to heading">#</a>References</h3><p>[1] - <a href="https://github.com/SirToffski/WireGuard-Ligase/wiki/About-the-project">https://github.com/SirToffski/WireGuard-Ligase/wiki/About-the-project</a> - Wiki for my <a href="https://github.com/SirToffski/WireGuard-Ligase">WireGuard-Ligase</a> project.<br>
[2] - <a href="https://www.wireguard.com/">https://www.wireguard.com/</a> - Official WireGuard website.<br>
[3] - <a href="https://www.wireguard.com/papers/wireguard.pdf">https://www.wireguard.com/papers/wireguard.pdf</a> - a whitepaper by WireGuard founder and lead developer - Jason A. Donenfeld<br>
[4] - <a href="https://hal.inria.fr/hal-02100345/document">https://hal.inria.fr/hal-02100345/document</a> - a formal research paper presenting the first mechanised cryptographic proof of the protocol underlying WireGuard.</p></section></article></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/my-recipes">Food</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/scripts">Scripts</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">About me</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/SirToffski?tab=repositories">GitHub</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://medium.com/@Ninja">Medium</a></li></ul></div></div><div class="text--center">Copyright © 2020 SirToffski, Built with Docusaurus.</div></div></footer>
</div>

<script src="/styles.bf915f3a.js"></script>

<script src="/runtime~main.5abe92a8.js"></script>

<script src="/main.f942447b.js"></script>

<script src="/1.c799fc6c.js"></script>

<script src="/2.d1470651.js"></script>

<script src="/ccc49370.df911bb1.js"></script>

<script src="/9651db9a.f8ce6bac.js"></script>


</body>
</html>